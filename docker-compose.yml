version: '3.8'

services:
  # 1. Frontend (Next.js)
  frontend:
    build: 
      context: ./services/frontend
    container_name: alzheimer-frontend
    restart: unless-stopped
    # ผูก Volume เพื่อให้แก้โค้ดที่เครื่องเรา แล้วเว็บอัปเดตทันทีโดยไม่ต้อง Build ใหม่
    volumes:
      - ./services/frontend:/app
      - /app/node_modules
    networks:
      - app-network

  # 2. Backend API Gateway (Node.js)
  backend-core:
    build: 
      context: ./services/backend-core
    container_name: alzheimer-backend
    restart: unless-stopped
    volumes:
      - ./services/backend-core:/app
      - /app/node_modules
    environment:
      - PORT=3000
      - AI_SERVICE_URL=http://ai-service:5000/predict
    networks:
      - app-network

  # 3. AI Service (Python/FastAPI)
  ai-service:
    build: 
      context: ./services/ai-service
    container_name: alzheimer-ai
    restart: unless-stopped
    volumes:
      - ./services/ai-service:/app
    networks:
      - app-network

  # 4. Nginx (Reverse Proxy)
  nginx:
    image: nginx:alpine
    container_name: alzheimer-nginx
    restart: always
    ports:
      - "80:80"  # เปิด Port 80 ให้เครื่องเราเข้าถึงได้
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - frontend
      - backend-core
    networks:
      - app-network

# สร้าง Network ให้แต่ละ Service คุยกันผ่านชื่อ Service ได้เลย (เช่น http://backend-core)
networks:
  app-network:
    driver: bridge