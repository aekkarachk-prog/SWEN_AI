services:
  # Service 1: Database Setup
  # ใช้ MongoDB สำหรับเก็บข้อมูลของทุก Service
  mongo-db:
    image: mongo:latest
    container_name: alz-mongo
    ports:
      # รูปแบบคือ "Port เครื่องเรา : Port ใน Container"
      # หาก Port 27017 ในเครื่องเราชนกับโปรแกรมอื่น ให้แก้เลขตัวหน้า เช่น "27018:27017"
      - "27017:27017"
    volumes:
      # การ Map Volume เพื่อให้ข้อมูลไม่หายเมื่อปิด Container
      # mongo-data คือชื่อ Volume ที่เราสร้างไว้ด้านล่างสุด
      - mongo-data:/data/db
    networks:
      - app-network

  # Service 2: API Gateway
  # ทำหน้าที่เป็นตัวกลางรับ Request จาก Frontend แล้วแจกจ่ายไปยัง Service อื่นๆ
  gateway:
    image: nginx:alpine
    container_name: alz-gateway
    ports:
      # เปิด Port 8080 สำหรับเข้าใช้งานเว็บผ่าน Browser (http://localhost:8080)
      - "8080:80"
    volumes:
      # โหลดไฟล์ตั้งค่า nginx.conf เข้าไปใน Container
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      # ระบุว่าต้องให้ Service เหล่านี้รันเสร็จก่อน Gateway ถึงจะเริ่มทำงาน
      - auth-service
      - patient-service
      - ai-service
    networks:
      - app-network

  # Service 3: Frontend Application
  # ส่วนแสดงผลที่เขียนด้วย React
  frontend:
    build: ./frontend
    container_name: alz-frontend
    ports:
      - "3000:3000"
    environment:
      # กำหนด URL ของ API Gateway ให้ Frontend รู้จัก
      # หากมีการเปลี่ยน Port Gateway ต้องมาแก้ที่นี่ด้วย
      - REACT_APP_API_URL=http://localhost:8080/api
    # stdin_open และ tty จำเป็นสำหรับ React เพื่อแก้ปัญหา Container ปิดตัวเองทันที
    stdin_open: true
    tty: true
    networks:
      - app-network

  # Service 4: Auth Service
  # จัดการเรื่องการ Login และ Token (JWT)
  auth-service:
    build: ./services/auth-service
    container_name: svc-auth
    environment:
      - PORT=3000
      # Connection String สำหรับต่อ Database ภายใน Docker Network
      - MONGO_URI=mongodb://mongo-db:27017/auth_db
      # คีย์ลับสำหรับเข้ารหัส Token (ควรเปลี่ยนเมื่อนำขึ้น Production)
      - JWT_SECRET=dev_secret_key
    depends_on:
      - mongo-db
    networks:
      - app-network

  # Service 5: Patient Service
  # จัดการข้อมูลผู้ป่วย (CRUD)
  patient-service:
    build: ./services/patient-service
    container_name: svc-patient
    environment:
      - PORT=3000
      - MONGO_URI=mongodb://mongo-db:27017/patient_db
    depends_on:
      - mongo-db
    networks:
      - app-network

  # Service 6: AI Inference Service (Python)
  # ส่วนประมวลผลโมเดล AI
  ai-service:
    build: ./services/ai-service
    container_name: svc-ai
    environment:
      - PORT=5000
    networks:
      - app-network

  # Service 7: Image & Diagnosis Service
  # จัดการรูปภาพและส่งต่อให้ AI
  image-service:
    build: ./services/image-service
    container_name: svc-image
    environment:
      - PORT=3000
      - MONGO_URI=mongodb://mongo-db:27017/image_db
      # URL สำหรับเรียกใช้งาน AI Service ภายใน Docker Network
      # ใช้ชื่อ Container "svc-ai" แทน localhost
      - AI_SERVICE_URL=http://svc-ai:5000/predict
    depends_on:
      - mongo-db
      - ai-service
    networks:
      - app-network

  # Service 8: History Service
  # จัดการประวัติการรักษา
  history-service:
    build: ./services/history-service
    container_name: svc-history
    environment:
      - PORT=3000
      - MONGO_URI=mongodb://mongo-db:27017/history_db
    depends_on:
      - mongo-db
    networks:
      - app-network

  # Service 9: Analytics Service
  # จัดการข้อมูลสถิติและ Dashboard
  analytics-service:
    build: ./services/analytics-service
    container_name: svc-analytics
    environment:
      - PORT=3000
      - MONGO_URI=mongodb://mongo-db:27017/analytics_db
    depends_on:
      - mongo-db
    networks:
      - app-network

# Network Configuration
# สร้างวง Network ภายในชื่อ app-network เพื่อให้ Container คุยกันได้
networks:
  app-network:
    driver: bridge

# Volume Configuration
# พื้นที่เก็บข้อมูลถาวรของ Database
volumes:
  mongo-data: