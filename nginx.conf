events {
    # กำหนดจำนวน Connection สูงสุดที่ Nginx จะรับได้ต่อหนึ่ง Worker
    # ค่า 1024 เป็นค่ามาตรฐานที่เพียงพอสำหรับการใช้งานทั่วไป
    worker_connections 1024;
}

http {
    # ส่วนของการตั้งค่า Server
    server {
        # Nginx จะรอรับ Request ที่ Port 80 (ภายใน Container)
        # ซึ่งใน docker-compose เรา Map ไว้ให้ตรงกับ Port 8080 ของเครื่องเรา
        listen 80;

        # =========================================================
        # CORS Configuration (สำคัญมาก)
        # =========================================================
        # ส่วนนี้จำเป็นเพื่อให้ Frontend (ที่รันบน Port 3000) สามารถยิง API ข้ามมาหา Backend ได้
        # หากไม่มีส่วนนี้ Browser จะบล็อกการเชื่อมต่อด้วยเหตุผลด้านความปลอดภัย
        
        # อนุญาตให้ทุก Domain เข้าถึงได้ (ในการใช้งานจริงอาจเปลี่ยน * เป็นโดเมนเฉพาะ)
        add_header 'Access-Control-Allow-Origin' '*' always;
        # อนุญาต HTTP Methods เหล่านี้
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
        # อนุญาต Headers ที่จำเป็นสำหรับการส่ง Token และข้อมูลต่างๆ
        add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;

        # จัดการ Pre-flight Requests (OPTIONS)
        # Browser จะส่ง Request แบบ OPTIONS มาเช็คก่อนเสมอว่าส่งข้อมูลจริงได้ไหม
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE';
            add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization';
            add_header 'Content-Type' 'text/plain; charset=utf-8';
            add_header 'Content-Length' 0;
            return 204;
        }

        # =========================================================
        # Routing Logic (การแจกจ่ายงานไปยัง Microservices)
        # =========================================================

        # 1. Auth Service Route
        # เมื่อ Frontend เรียก /api/auth ให้ส่งต่อไปยัง Auth Service
        location /api/auth {
            # proxy_pass: ส่งต่อ Request ไปยัง Container ปลายทาง
            # "svc-auth": ต้องตรงกับ container_name ที่ตั้งใน docker-compose.yml
            # "3000": ต้องตรงกับ Port ที่ Node.js รันอยู่ภายใน Container นั้น
            proxy_pass http://svc-auth:3000;
            
            # ส่ง Header เดิมของคนเรียกตามไปด้วย เพื่อให้ Backend รู้ IP จริงของผู้ใช้
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # 2. Patient Service Route
        # เมื่อเรียก /api/patients ส่งไปหา Patient Service
        location /api/patients {
            proxy_pass http://svc-patient:3000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # 3. Diagnosis/Image Service Route
        # เมื่อเรียก /api/diagnosis ส่งไปหา Image Service
        location /api/diagnosis {
            proxy_pass http://svc-image:3000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # 4. History Service Route
        # เมื่อเรียก /api/history ส่งไปหา History Service
        location /api/history {
            proxy_pass http://svc-history:3000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # 5. Analytics Service Route
        # เมื่อเรียก /api/analytics ส่งไปหา Analytics Service
        location /api/analytics {
            proxy_pass http://svc-analytics:3000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # หมายเหตุ: AI Service ไม่ถูกกำหนดในนี้ เพราะ Frontend จะไม่เรียก AI โดยตรง
        # แต่ Frontend จะเรียก Image Service และ Image Service จะเรียก AI ภายใน Docker Network เอง
    }
}